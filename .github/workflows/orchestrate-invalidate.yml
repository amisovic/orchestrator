name: Orchestrate Invalidate

run-name: ${{ format('Invalidate PRs - {0}', github.run_id) }}

on:
  workflow_dispatch:
  repository_dispatch:
    types: [invalidate]

jobs:
  invalidate-prs:
    if: github.event_name == 'repository_dispatch' && github.event.client_payload.action == 'invalidate'
    runs-on: ubuntu-latest
    steps:
    - name: Post failure statuses to invalidate PRs
      run: |
        repos=("amisovic/repoA" "amisovic/repoB" "amisovic/repoC" "amisovic/repoD" "amisovic/repoE")
        for repo in "${repos[@]}"; do
          echo "Checking PRs for $repo"
          prs=$(gh pr list --repo $repo --base main --state open --json number,headRefOid)
          echo "PRs: $prs"
          if [ "$prs" != "[]" ]; then
            echo "$prs" | jq -r '.[] | @base64' | while read pr_encoded; do
              pr=$(echo $pr_encoded | base64 --decode)
              pr_number=$(echo $pr | jq -r '.number')
              head_sha=$(echo $pr | jq -r '.headRefOid')
              echo "Invalidating PR #$pr_number with SHA $head_sha for $repo"
              gh api -X POST /repos/$repo/statuses/$head_sha -f state=failure -f context=orchestrator-build -f description="PR changed, re-run orchestrator"
              echo "Posted invalidate for $repo PR #$pr_number"
            done
          else
            echo "No open PRs for $repo"
          fi
        done
      env:
        GITHUB_TOKEN: ${{ secrets.PAT_WORKFLOWS }}