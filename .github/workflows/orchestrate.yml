name: Orchestrate Builds

on:
  workflow_dispatch:

jobs:
  trigger-repoA:
    runs-on: ubuntu-latest
    steps:
    - name: Trigger repoA build and wait
      run: |
        echo "Triggering repoA build..."
        gh workflow run build.yml --repo amisovic/repoA --field orchestrator_runid=${{ github.run_id }}
        echo "Workflow dispatch sent."
        
        # Wait a moment for the run to be created
        sleep 5
        
        # Get the run ID by matching the run name
        run_id=$(gh run list --repo amisovic/repoA --workflow build.yml --json id,name --jq ".[] | select(.name == \"Build-Orch-${{ github.run_id }}\") | .id")
        echo "Found run ID: $run_id"
        
        echo "Waiting for repoA build to complete..."
        while true; do
          status=$(gh run view $run_id --repo amisovic/repoA --json status -q .status)
          conclusion=$(gh run view $run_id --repo amisovic/repoA --json conclusion -q .conclusion)
          echo "Current status: $status, conclusion: $conclusion"
          if [ "$status" = "completed" ]; then
            if [ "$conclusion" = "success" ]; then
              echo "repoA build succeeded!"
            else
              echo "repoA build failed with conclusion: $conclusion"
              exit 1
            fi
            break
          fi
          sleep 10
        done
      env:
        GITHUB_TOKEN: ${{ secrets.PAT_WORKFLOWS }}